name: Build Native Libraries

on:
  workflow_dispatch:  # Manual trigger only

env:
  ANDROID_NDK_VERSION: r25b
  CMAKE_VERSION: "3.14.7"

jobs:
  build-ttp:
    name: Build TAK Third Party (arm64-v8a)
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      - name: Checkout (skip LFS)
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            autoconf \
            automake \
            libtool \
            pkg-config \
            cmake \
            python3 \
            python3-pip \
            swig \
            ant \
            tcl \
            dos2unix \
            nasm \
            yasm \
            patch \
            wget \
            unzip \
            file

      - name: Install Conan
        run: |
          pip3 install conan
          conan profile detect
          PROFILE_PATH=$(conan profile path default)
          sed -i 's/compiler.version=.*/compiler.version=8/' "$PROFILE_PATH" || true
          conan profile show

      - name: Setup Android NDK (r25b)
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-${ANDROID_NDK_VERSION}-linux.zip -O ndk.zip
          unzip -q ndk.zip -d $HOME
          echo "ANDROID_NDK=$HOME/android-ndk-${ANDROID_NDK_VERSION}" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$HOME/android-ndk-${ANDROID_NDK_VERSION}" >> $GITHUB_ENV

          # Create compatibility symlinks for OpenSSL and other configure scripts
          # NDK r25b ships versioned tools (e.g. aarch64-linux-android21-clang)
          # but configure scripts look for unversioned names
          NDK_TC=$HOME/android-ndk-${ANDROID_NDK_VERSION}/toolchains/llvm/prebuilt/linux-x86_64/bin
          ln -sf aarch64-linux-android21-clang   "$NDK_TC/aarch64-linux-android-clang"
          ln -sf aarch64-linux-android21-clang++ "$NDK_TC/aarch64-linux-android-clang++"
          ln -sf aarch64-linux-android21-clang   "$NDK_TC/aarch64-linux-android-gcc"
          ln -sf aarch64-linux-android21-clang++ "$NDK_TC/aarch64-linux-android-g++"
          ln -sf llvm-ar "$NDK_TC/aarch64-linux-android-ar"
          ln -sf llvm-ranlib "$NDK_TC/aarch64-linux-android-ranlib"

          # Add NDK toolchain to system PATH for all subsequent steps
          # MUST come BEFORE system /usr/bin so NDK's clang is found first
          # (OpenSSL Configure checks `which clang` and requires it to be in NDK)
          echo "$NDK_TC" >> $GITHUB_PATH

          echo "=== Verify NDK tools ==="
          ls -la "$NDK_TC/clang" "$NDK_TC/aarch64-linux-android-gcc" "$NDK_TC/aarch64-linux-android-clang"
          "$NDK_TC/clang" --version | head -1

      - name: Setup CMake 3.14.7
        run: |
          wget -q https://cmake.org/files/v3.14/cmake-${CMAKE_VERSION}-Linux-x86_64.tar.gz
          tar xzf cmake-${CMAKE_VERSION}-Linux-x86_64.tar.gz -C $HOME
          echo "$HOME/cmake-${CMAKE_VERSION}-Linux-x86_64/bin" >> $GITHUB_PATH

      - name: Setup JDK 8 (for Java bindings)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'

      # ============================================================
      # Download distfiles from upstream sources
      # Versions from takthirdparty/distfiles/README
      # ============================================================
      - name: Download distfiles from upstream
        run: |
          cd takthirdparty/distfiles

          echo "=== Downloading zlib 1.3.1 ==="
          wget -q https://zlib.net/fossils/zlib-1.3.1.tar.gz -O zlib.tar.gz

          echo "=== Downloading OpenSSL 3.0.14+quic ==="
          wget -q https://github.com/quictls/openssl/archive/refs/tags/openssl-3.0.14-quic1.tar.gz -O openssl.tar.gz

          echo "=== Downloading curl 8.9.1 ==="
          wget -q https://curl.se/download/curl-8.9.1.tar.bz2 -O curl.tar.bz2

          echo "=== Downloading PROJ 4.9.1 ==="
          wget -q https://download.osgeo.org/proj/proj-4.9.1.tar.gz -O proj.tar.gz

          echo "=== Downloading expat 2.1.0 ==="
          wget -q https://github.com/libexpat/libexpat/releases/download/R_2_1_0/expat-2.1.0.tar.gz -O expat.tar.gz

          echo "=== Downloading libkml 1.3 ==="
          wget -q https://github.com/libkml/libkml/archive/refs/tags/1.3.0.tar.gz -O libkml.tar.gz

          echo "=== Downloading libxml2 2.13.3 ==="
          wget -q https://download.gnome.org/sources/libxml2/2.13/libxml2-2.13.3.tar.xz -O libxml2.tar.xz

          echo "=== Downloading libmicrohttpd 1.0.1 ==="
          wget -q https://ftp.gnu.org/gnu/libmicrohttpd/libmicrohttpd-1.0.1.tar.gz -O libmicrohttpd.tar.gz

          echo "=== Downloading mdbtools 1.0.0 ==="
          wget -q https://github.com/mdbtools/mdbtools/releases/download/v1.0.0/mdbtools-1.0.0.tar.gz -O mdbtools.tar.gz

          echo "=== Downloading nghttp2 1.62.1 ==="
          wget -q https://github.com/nghttp2/nghttp2/releases/download/v1.62.1/nghttp2-1.62.1.tar.bz2 -O nghttp2.tar.bz2

          echo "=== Downloading ngtcp2 1.6.0 ==="
          wget -q https://github.com/ngtcp2/ngtcp2/releases/download/v1.6.0/ngtcp2-1.6.0.tar.bz2 -O ngtcp2.tar.bz2

          echo "=== Downloading ogdi 3.2.0 ==="
          wget -q https://github.com/libogdi/ogdi/archive/refs/tags/ogdi_3_2_0.tar.gz -O ogdi.tar.gz

          echo "=== Downloading GEOS 3.4.3 ==="
          wget -q https://download.osgeo.org/geos/geos-3.4.3.tar.bz2 -O geos.tar.bz2

          echo "=== Downloading SQLCipher 4.5.7 ==="
          wget -q https://github.com/sqlcipher/sqlcipher/archive/refs/tags/v4.5.7.tar.gz -O sqlcipher.tar.gz

          echo "=== Downloading libiconv 1.15 ==="
          wget -q https://ftp.gnu.org/pub/gnu/libiconv/libiconv-1.15.tar.gz -O libiconv.tar.gz

          echo "=== Downloading protobuf 3.21.0 (cpp) ==="
          wget -q https://github.com/protocolbuffers/protobuf/releases/download/v21.0/protobuf-cpp-3.21.0.tar.gz -O protobuf.tar.gz

          echo "=== Downloading libspatialite 4.3.0a ==="
          wget -q https://www.gaia-gis.it/gaia-sins/libspatialite-sources/libspatialite-4.3.0a.tar.gz -O libspatialite.tar.gz || \
          wget -q https://www.gaia-gis.it/gaia-sins/libspatialite-4.3.0a.tar.gz -O libspatialite.tar.gz || \
          echo "WARNING: libspatialite download may need manual URL"

          echo "=== Verify downloads ==="
          ls -la *.tar.gz *.tar.bz2 *.tar.xz 2>/dev/null
          echo "=== Check for any empty/failed downloads ==="
          find . -name "*.tar.*" -size -1k -exec echo "FAILED: {}" \;

      # ============================================================
      # Download depends for assimp etc.
      # ============================================================
      - name: Download modified depends
        run: |
          cd depends

          echo "=== Downloading ASSIMP 4.0.1 ==="
          wget -q https://github.com/assimp/assimp/archive/refs/tags/v4.0.1.tar.gz -O assimp-vanilla.tar.gz || true

          echo "=== Downloading tinygltf 2.4.1 ==="
          wget -q https://github.com/syoyo/tinygltf/archive/refs/tags/v2.4.1.tar.gz -O tinygltf-vanilla.tar.gz || true

          echo "=== Downloading tinygltfloader 0.9.5 ==="
          wget -q https://github.com/syoyo/tinygltfloader/archive/refs/tags/v0.9.5.tar.gz -O tinygltfloader-vanilla.tar.gz || true

          ls -la *.tar.gz 2>/dev/null

      # ============================================================
      # Unpack source trees to expected locations
      # ============================================================
      - name: Prepare source trees
        run: |
          set +e  # Don't fail on individual steps

          # ASSIMP - unpack to repo root as 'assimp'
          if [ -f depends/assimp-vanilla.tar.gz ] && [ $(stat -c%s depends/assimp-vanilla.tar.gz) -gt 1000 ]; then
            echo "=== Unpacking ASSIMP ==="
            mkdir -p assimp-tmp && tar xzf depends/assimp-vanilla.tar.gz -C assimp-tmp
            extracted=$(find assimp-tmp -maxdepth 1 -mindepth 1 -type d | head -1)
            if [ -n "$extracted" ]; then
              mv "$extracted" assimp
              echo "ASSIMP extracted to assimp/"
            fi
            rm -rf assimp-tmp
          fi

          # tinygltf - unpack to takengine/thirdparty
          mkdir -p takengine/thirdparty
          for pkg in tinygltf tinygltfloader; do
            tarball="depends/${pkg}-vanilla.tar.gz"
            if [ -f "$tarball" ] && [ $(stat -c%s "$tarball") -gt 1000 ]; then
              echo "=== Unpacking $pkg ==="
              mkdir -p "${pkg}-tmp" && tar xzf "$tarball" -C "${pkg}-tmp"
              extracted=$(find "${pkg}-tmp" -maxdepth 1 -mindepth 1 -type d | head -1)
              if [ -n "$extracted" ]; then
                mv "$extracted" "takengine/thirdparty/${pkg}"
              fi
              rm -rf "${pkg}-tmp"
            fi
          done

          # STLSoft
          git clone --depth 1 https://github.com/synesissoftware/STLSoft-1.9.git stl-soft
          git clone --depth 1 https://github.com/synesissoftware/STLSoft-1.9.git takengine/thirdparty/stlsoft

          echo "=== Verify source trees ==="
          for d in assimp stl-soft takengine/thirdparty/stlsoft commoncommo; do
            if [ -d "$d" ]; then
              echo "  OK: $d/"
            else
              echo "  MISSING: $d/"
            fi
          done

      # ============================================================
      # Build takthirdparty for arm64-v8a
      # Skip build_gdal for now (needs pdfium/mrsid LFS binaries)
      # ============================================================
      - name: Build takthirdparty (arm64-v8a)
        run: |
          set -o pipefail

          # Ensure NDK toolchain is first on PATH (before /usr/bin/clang)
          # OpenSSL Configure perl script checks `which clang` and needs NDK's clang
          export PATH="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"

          echo "=== Verify NDK toolchain on PATH ==="
          which clang || echo "clang: not found"
          which aarch64-linux-android-gcc || echo "gcc shim: not found"
          which aarch64-linux-android-clang || echo "clang shim: not found"
          echo "ANDROID_NDK=$ANDROID_NDK"
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME"

          # Debug: simulate OpenSSL's Perl detection logic
          perl -e '
            use File::Spec::Functions;
            my $ndk;
            foreach (qw(ANDROID_NDK_ROOT ANDROID_NDK)) {
              $ndk = $ENV{$_};
              last if defined $ndk;
            }
            print "ndk=$ndk\n";
            $ndk = canonpath($ndk) if $ndk;
            print "ndk(canon)=$ndk\n";
            print "is_ndk=" . (-f "$ndk/source.properties" ? "yes" : "no") . "\n";
            print "is_standalone=" . (-f "$ndk/AndroidVersion.txt" ? "yes" : "no") . "\n";

            # Check which clang
            my @path = split(/:/, $ENV{PATH});
            print "PATH entries with ndk:\n";
            for my $d (@path) {
              print "  $d\n" if $d =~ /ndk/;
            }

            # Simulate which()
            sub mywhich {
              my $name = shift;
              for my $d (@path) {
                my $f = "$d/$name";
                return $f if (-f $f and -x $f);
              }
              return "";
            }

            my $clang = mywhich("clang");
            print "which(clang)=$clang\n";
            print "  matches ndk: " . ($clang =~ m|^$ndk/.*/prebuilt/([^/]+)/| ? "YES ($1)" : "NO") . "\n" if $clang;

            my $gcc = mywhich("aarch64-linux-android-gcc");
            print "which(gcc)=$gcc\n";
            print "  matches ndk: " . ($gcc =~ m|^$ndk/.*/prebuilt/([^/]+)/| ? "YES ($1)" : "NO") . "\n" if $gcc;

            my $aclang = mywhich("aarch64-linux-android-clang");
            print "which(android-clang)=$aclang\n";

            # Also try IPC::Cmd
            if (eval { require IPC::Cmd; 1; }) {
              IPC::Cmd->import();
              my $r = IPC::Cmd::can_run("aarch64-linux-android-gcc");
              print "IPC::Cmd::can_run(gcc)=" . ($r // "undef") . "\n";
              my $c = IPC::Cmd::can_run("clang");
              print "IPC::Cmd::can_run(clang)=" . ($c // "undef") . "\n";
            }
          '

          cd takthirdparty

          echo "=== Starting TTP build for android-arm64-v8a ==="
          echo "=== Building: spatialite, commoncommo, assimp ==="
          echo "=== Skipping: gdal (needs pdfium/mrsid LFS binaries) ==="

          make TARGET=android-arm64-v8a \
               GDAL_USE_KDU=no \
               build_spatialite build_commoncommo build_assimp \
               2>&1 | tee /tmp/ttp-build.log

          echo "=== Build complete ==="
          echo "=== Libraries built ==="
          ls -la builds/android-arm64-v8a-release/lib/ 2>/dev/null
          echo "=== Headers ==="
          ls builds/android-arm64-v8a-release/include/ 2>/dev/null | head -30
          echo "=== Java ==="
          ls builds/android-arm64-v8a-release/java/ 2>/dev/null

      # ============================================================
      # Upload build artifacts
      # ============================================================
      - name: Collect artifacts
        if: always()
        run: |
          mkdir -p artifacts/arm64-v8a

          # Collect from TTP build
          if [ -d takthirdparty/builds/android-arm64-v8a-release ]; then
            cp -r takthirdparty/builds/android-arm64-v8a-release/lib artifacts/arm64-v8a/ttp-lib || true
            cp -r takthirdparty/builds/android-arm64-v8a-release/include artifacts/arm64-v8a/ttp-include || true
            cp -r takthirdparty/builds/android-arm64-v8a-release/java artifacts/arm64-v8a/ttp-java || true
          fi

          # Collect build log
          cp /tmp/ttp-build.log artifacts/ 2>/dev/null || true

          echo "=== Artifact summary ==="
          echo "Static libraries (.a):"
          find artifacts -name "*.a" | sort
          echo ""
          echo "Shared libraries (.so):"
          find artifacts -name "*.so" | sort
          echo ""
          echo "Java jars:"
          find artifacts -name "*.jar" | sort

      - name: Upload native library artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: atak-native-arm64-v8a
          path: artifacts/
          retention-days: 90

      - name: Upload build log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: /tmp/ttp-build.log
          retention-days: 30
